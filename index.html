<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Victory Road - Tier List (4.0.1)</title>

<link rel="stylesheet" href="style.css">
</head>

<body>
<h1>Victory Road - Tier List (4.0.1)</h1>
<div class="author">Created by @Juninfs (Discord) / Based on @danifdez (Discord)'s Tier List</div>

<!-- MAIN MODE TABS -->
<div class="tabs">
  <div class="tab active" id="tab-players">Players</div>
  <div class="tab" id="tab-basara">Fabled</div>
</div>

<!-- POSITION TABS -->
<div class="tabs" id="position-tabs">
  <div class="tab active" id="tab-fw">FW</div>
  <div class="tab" id="tab-mf">MF</div>
  <div class="tab" id="tab-df">DF</div>
  <div class="tab" id="tab-gk">GK</div>
</div>

<!-- Search + Filters + Level -->
<div class="search-container">
  <input type="text" id="search-bar" placeholder="Search character...">

  <select id="player-level" class="player-level-select">
    <option value="1">Normal Player</option>
    <option value="1.1">Growing Player</option>
    <option value="1.2">Advanced Player</option>
    <option value="1.3">Top Player</option>
    <option value="1.4">Legendary Player</option>
  </select>

  <div class="filter-dropdown-container">
    <button id="filter-btn">⚙️</button>
    <div class="filter-dropdown" id="filter-dropdown">
      <select id="filter-gender">
        <option value="">All Genders</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
        <option value="Unknown">Unknown</option>
        <option value="Neutral">Neutral</option>
        <option value="None">None</option>
      </select>
      <select id="filter-element">
        <option value="">All Elements</option>
        <option value="Wind">Wind</option>
        <option value="Forest">Forest</option>
        <option value="Fire">Fire</option>
        <option value="Mountain">Mountain</option>
      </select>
      <button id="reset-filters">Reset Filters</button>
    </div>
  </div>

  <div class="search-results" id="search-results"></div>
</div>

<div class="tier-bar" id="tier-bar"></div>

<div class="stats-panel" id="stats-panel">
  <div class="stats-section">
    <h3>Stats</h3>
    <div class="stats-grid" id="stats-basic"></div>
  </div>
  <div class="stats-section">
    <h3>AT / DF</h3>
    <div class="stats-grid" id="stats-atdf"></div>
  </div>
</div>

<div class="tier-grid" id="tier-grid"></div>

<script>
/* =========================================================
   CONFIG / DADOS
========================================================= */
const SHEET_ID="1N4h7z27Rxq3bvYuR9VyeQv3Ze-zwo-1XZQTd9rZa-Zs";
const GID_MAIN="1173802089";
const GID_STATS="425305907";
const URL_MAIN=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${GID_MAIN}`;
const URL_STATS=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${GID_STATS}`;

const BASIC_STATS=["Kick","Control","Technique","Pressure","Physical","Agility","Intelligence","Total Stats"];
const ATDF_STATS=["Shot AT","Focus AT","Focus DF","Scramble AT","Scramble DF","Castle Wall DF","KP"];

/* === TIERS ORIGINAIS (para ranking base) === */
const GK_TIERS=[{tier:"G5",Total:689,KP:955},{tier:"G4+",Total:674,KP:940},{tier:"G3+",Total:674,KP:934},{tier:"G4-",Total:667,KP:935},{tier:"G3-",Total:667,KP:925},{tier:"G2",Total:656,KP:913}];
const FW_TIERS=[{tier:"G5",Shot:236,Total:692},{tier:"G4+",Shot:233,Total:682},{tier:"G4",Shot:232,Total:671},{tier:"G4-",Shot:230,Total:666},{tier:"G3+",Shot:226,Total:692},{tier:"G3-",Shot:224,Total:683},{tier:"G2+",Shot:221,Total:672},{tier:"G2-",Shot:219,Total:665}];
const MF_TIERS=[
  {tier:"G5+",FocusAT:281,FocusDF:189,Total:693},{tier:"G5-",FocusAT:277,FocusDF:259,Total:683},{tier:"G4+",FocusAT:275,FocusDF:255,Total:672},
  {tier:"G3+",FocusAT:273,FocusDF:253,Total:667},{tier:"G4-",FocusAT:273,FocusDF:251,Total:693},{tier:"G3-",FocusAT:270,FocusDF:248,Total:684},
  {tier:"G2+",FocusAT:266,FocusDF:244,Total:672},{tier:"G2-",FocusAT:264,FocusDF:242,Total:667}
];
const DF_TIERS=[
  {tier:"GO",CastleWallDF:214,FocusDF:254,Total:690},{tier:"G5 CB",CastleWallDF:211,FocusDF:248,Total:675},{tier:"G5 FB",CastleWallDF:207,FocusDF:254,Total:691},
  {tier:"G4 CB",CastleWallDF:209,FocusDF:248,Total:671},{tier:"G4 FB",CastleWallDF:203,FocusDF:248,Total:674},
  {tier:"G3 CB",CastleWallDF:208,FocusDF:244,Total:663},{tier:"G3 FB",CastleWallDF:202,FocusDF:248,Total:672},{tier:"G2",CastleWallDF:199,FocusDF:246,Total:663}
];

/* =========================================================
   ESTADO
========================================================= */
let rows=[], cols={}, statsMap={};
let currentRole="FW";
let currentMode="players"; // players | basara
let currentMultiplier=1.0;
let lastShownChar=null;

const tierBar=document.getElementById("tier-bar");
const tierGrid=document.getElementById("tier-grid");
const statsPanel=document.getElementById("stats-panel");
const statsBasic=document.getElementById("stats-basic");
const statsATDF=document.getElementById("stats-atdf");

const lastSelectedTier = { 
  FW: { players: "G5", basara: "Fabled+" }, 
  MF: { players: "G5+", basara: "Fabled+" }, 
  DF: { players: "GO", basara: "Fabled+" }, 
  GK: { players: "G5", basara: "Fabled+" } 
};

let currentFilterGender = "";
let currentFilterElement = "";

// Elementos DOM
const playerLevelSelect = document.getElementById("player-level");

/* =========================================================
   FORMULAS - CORREÇÃO: Multiplica primeiro, DEPOIS arredonda para baixo
========================================================= */
function floor(value) {
  return Math.floor(value);
}

function calcDerived(s){
  return {
    "Shot AT": floor(s.Kick + s.Control),
    "Focus AT": floor((s.Control + s.Technique) + (s.Kick * 0.5)),
    "Focus DF": floor((s.Intelligence + s.Technique) + (s.Agility * 0.5)),
    "Scramble AT": floor(s.Physical + s.Intelligence),
    "Scramble DF": floor(s.Pressure + s.Intelligence),
    "Castle Wall DF": floor(s.Physical + s.Pressure),
    "KP": floor((s.Agility * 4) + (s.Physical * 3) + (s.Pressure * 2))
  };
}

function getScaledStats(obj){
  const base = {
    Kick: obj.Kick,
    Control: obj.Control,
    Technique: obj.Technique,
    Pressure: obj.Pressure,
    Physical: obj.Physical,
    Agility: obj.Agility,
    Intelligence: obj.Intelligence
  };
  const scaled = {};
  for(const k in base){
    // CORREÇÃO: Multiplica primeiro, DEPOIS arredonda para baixo
    scaled[k] = Math.floor(base[k] * currentMultiplier + 1e-9);
  }
  const derived = calcDerived(scaled);
  const total = Object.values(scaled).reduce((a,b)=>a+b,0);
  return { ...scaled, ...derived, "Total Stats": total };
}

/* =========================================================
   TIER CALC (SEMPRE BASE)
========================================================= */
function calcTier(obj){
  if(obj.role==="GK"){ for(const t of GK_TIERS) if(obj["Total Stats"]>=t.Total && obj.KP>=t.KP) return t.tier; }
  else if(obj.role==="FW"){ for(const t of FW_TIERS) if(obj["Shot AT"]>=t.Shot && obj["Total Stats"]>=t.Total) return t.tier; }
  else if(obj.role==="MF"){ for(const t of MF_TIERS) if(obj["Focus AT"]>=t.FocusAT && obj["Focus DF"]>=t.FocusDF && obj["Total Stats"]>=t.Total) return t.tier; }
  else if(obj.role==="DF"){ for(const t of DF_TIERS) if(obj["Castle Wall DF"]>=t.CastleWallDF && obj["Focus DF"]>=t.FocusDF && obj["Total Stats"]>=t.Total) return t.tier; }
  return null;
}

/* =========================================================
   SHOW STATS - CORREÇÃO: Basara mostra nos lugares corretos
========================================================= */
function showStats(obj){
  lastShownChar = obj;
  statsBasic.innerHTML=""; 
  statsATDF.innerHTML="";

  if(currentMode==="players"){
    const s = getScaledStats(obj);
    // Stats básicos no painel superior
    ["Kick","Control","Technique","Pressure","Physical","Agility","Intelligence","Total Stats"].forEach(k=>{
      statsBasic.innerHTML+=`<div class="stat"><span>${k}</span><strong>${s[k]}</strong></div>`;
    });
    // AT/DF no painel inferior
    ["Shot AT","Focus AT","Focus DF","Scramble AT","Scramble DF","Castle Wall DF","KP"].forEach(k=>{
      statsATDF.innerHTML+=`<div class="stat"><span>${k}</span><strong>${s[k]}</strong></div>`;
    });
  } else {
    // BASARA: Stats já estão calculados no objeto
    // Stats básicos no painel superior
    ["Kick","Control","Technique","Pressure","Physical","Agility","Intelligence","Total Stats"].forEach(k=>{
      statsBasic.innerHTML+=`<div class="stat"><span>${k}</span><strong>${obj[k]}</strong></div>`;
    });
    // AT/DF no painel inferior
    ["Shot AT","Focus AT","Focus DF","Scramble AT","Scramble DF","Castle Wall DF","KP"].forEach(k=>{
      statsATDF.innerHTML+=`<div class="stat"><span>${k}</span><strong>${obj[k]}</strong></div>`;
    });
  }
}

/* =========================================================
   UPDATE UI VISIBILITY
========================================================= */
function updateUIVisibility() {
  // Controla visibilidade do multiplicador
  if (currentMode === "players") {
    playerLevelSelect.style.display = "inline-block";
  } else {
    playerLevelSelect.style.display = "none";
  }
}

/* =========================================================
   UPDATE POSITION TABS ACTIVE STATE
========================================================= */
function updatePositionTabs() {
  const positionTabs = {
    fw: document.getElementById("tab-fw"),
    mf: document.getElementById("tab-mf"),
    df: document.getElementById("tab-df"),
    gk: document.getElementById("tab-gk")
  };
  
  // Remove active de todas
  Object.values(positionTabs).forEach(tab => tab.classList.remove("active"));
  
  // Adiciona active na posição atual
  switch(currentRole) {
    case "FW": positionTabs.fw.classList.add("active"); break;
    case "MF": positionTabs.mf.classList.add("active"); break;
    case "DF": positionTabs.df.classList.add("active"); break;
    case "GK": positionTabs.gk.classList.add("active"); break;
  }
}

/* =========================================================
   BUILD PLAYERS
========================================================= */
function buildPlayers(role){
  tierBar.innerHTML=""; 
  tierGrid.innerHTML=""; 
  statsPanel.style.display="none";

  let chars = rows.filter(r=>r.role===role && r.tier);
  if(currentFilterGender) chars = chars.filter(c => c.Gender === currentFilterGender);
  if(currentFilterElement) chars = chars.filter(c => c.Element === currentFilterElement);

  const tiers = role==="GK"?["G5","G4+","G3+","G4-","G3-","G2"]:
                role==="MF"?["G5+","G5-","G4+","G4-","G3+","G3-","G2+","G2-"]:
                role==="DF"?["GO","G5 CB","G5 FB","G4 CB","G4 FB","G3 CB","G3 FB","G2"]:
                ["G5","G4+","G4","G4-","G3+","G3-","G2+","G2-"];

  tiers.forEach(t => {
    const box = document.createElement("div");
    box.className = "tier-box";
    box.textContent = t;
    if(t === lastSelectedTier[role].players) box.classList.add("active");

    box.onclick = () => {
      lastSelectedTier[role].players = t;
      Array.from(tierBar.children).forEach(child=>child.classList.remove("active"));
      box.classList.add("active");

      tierGrid.innerHTML = "";
      const list = chars.filter(c=>c.tier===t);
      if(!list.length) return;
      statsPanel.style.display="block";
      showStats(list[list.length-1]);
      list.forEach(p=>{
        const c = document.createElement("div");
        c.className = "char-card";
        c.dataset.element = p.Element;
        c.innerHTML = `<img src="${p.Image}"><div class="char-tooltip"><div class="char-name">${p.name}</div><div class="char-element">${p.Element}</div></div>`;
        tierGrid.appendChild(c);
      });
    };
    tierBar.appendChild(box);
  });

  // Trigger click no tier salvo
  const boxes = tierBar.querySelectorAll(".tier-box");
  let clicked = false;
  boxes.forEach(box=>{
    if(box.textContent===lastSelectedTier[role].players) {
      box.click();
      clicked = true;
    }
  });
  if (!clicked && boxes.length > 0) boxes[0].click();
}

/* =========================================================
   BUILD BASARA
========================================================= */
const BASARA_STATS = {
  FW: {
    "Fabled+": { tiers:["G5","G4+","G4","G4-"], Kick:243,Control:231,Technique:211,Pressure:177,Physical:170,Agility:170,Intelligence:187 },
    "Fabled-": { tiers:["G3+","G3-","G2+","G2-"], Kick:229,Control:224,Technique:204,Pressure:182,Physical:177,Agility:170,Intelligence:201 }
  },
  GK: {
    "Fabled+": { tiers:["G5","G4+","G4-","G2"], Kick:180,Control:194,Technique:182,Pressure:197,Physical:211,Agility:222,Intelligence:194 },
    "Fabled-": { tiers:["G3+","G3-"], Kick:180,Control:194,Technique:182,Pressure:204,Physical:211,Agility:214,Intelligence:194 }
  },
  MF: {
    "Fabled+": { tiers:["G5+","G5-","G4+","G3+"], Kick:201,Control:231,Technique:232,Pressure:177,Physical:170,Agility:170,Intelligence:210 },
    "Fabled-": { tiers:["G4-","G3-","G2+","G2-"], Kick:210,Control:224,Technique:219,Pressure:182,Physical:184,Agility:170,Intelligence:201 }
  },
  DF: {
    "Fabled+": { tiers:["GO","G5 CB","G4 CB","G3 CB"], Kick:172,Control:180,Technique:177,Pressure:211,Physical:219,Agility:182,Intelligence:243 },
    "Fabled-": { tiers:["G5 FB","G4 FB","G3 FB","G2"], Kick:180,Control:189,Technique:190,Pressure:204,Physical:211,Agility:182,Intelligence:229 }
  }
};

function buildBasara(role){
  tierBar.innerHTML=""; 
  tierGrid.innerHTML=""; 
  statsPanel.style.display="none";

  // Filtros aplicados no Basara
  let chars = rows.filter(r=>r.role===role);
  if(currentFilterGender) chars = chars.filter(c => c.Gender === currentFilterGender);
  if(currentFilterElement) chars = chars.filter(c => c.Element === currentFilterElement);

  ["Fabled+","Fabled-"].forEach(bt=>{
    const box = document.createElement("div");
    box.className="tier-box";
    box.textContent=bt;
    if(bt === lastSelectedTier[role].basara) box.classList.add("active");

    box.onclick=()=>{
      lastSelectedTier[role].basara = bt;
      Array.from(tierBar.children).forEach(child=>child.classList.remove("active"));
      box.classList.add("active");
      tierGrid.innerHTML="";

      const cfg = BASARA_STATS[role][bt];
      const baseStats = {...cfg};
      delete baseStats.tiers;

      const derived = calcDerived(baseStats);
      const total = Object.values(baseStats).reduce((a,b)=>a+b,0);
      const statsObj = { ...baseStats, ...derived, "Total Stats": total };

      statsPanel.style.display="block";
      showStats(statsObj);

      // Aplica filtros aos personagens exibidos
      const filteredChars = chars.filter(p => cfg.tiers.includes(p.tier));
      filteredChars.forEach(p=>{
        const c = document.createElement("div");
        c.className="char-card";
        c.dataset.element=p.Element;
        c.innerHTML=`<img src="${p.Image}"><div class="char-tooltip"><div class="char-name">${p.name}</div><div class="char-element">${p.Element}</div></div>`;
        tierGrid.appendChild(c);
      });
    };

    tierBar.appendChild(box);
  });

  // Trigger click no tier salvo
  const boxes = tierBar.querySelectorAll(".tier-box");
  let clicked = false;
  boxes.forEach(box=>{
    if(box.textContent===lastSelectedTier[role].basara) {
      box.click();
      clicked = true;
    }
  });
  if (!clicked && boxes.length > 0) boxes[0].click();
}

/* =========================================================
   CONTROLES UI
========================================================= */
function build(){
  if(currentMode==="players") buildPlayers(currentRole);
  else buildBasara(currentRole);
  updateUIVisibility();
  updatePositionTabs();
}

// Tabs modo
document.getElementById("tab-players").onclick=()=>{
  currentMode="players";
  document.getElementById("tab-players").classList.add("active");
  document.getElementById("tab-basara").classList.remove("active");
  build();
};
document.getElementById("tab-basara").onclick=()=>{
  currentMode="basara";
  document.getElementById("tab-basara").classList.add("active");
  document.getElementById("tab-players").classList.remove("active");
  build();
};

// Tabs posição
document.getElementById("tab-fw").onclick=()=>{ 
  currentRole="FW"; 
  build(); 
};
document.getElementById("tab-mf").onclick=()=>{ 
  currentRole="MF"; 
  build(); 
};
document.getElementById("tab-df").onclick=()=>{ 
  currentRole="DF"; 
  build(); 
};
document.getElementById("tab-gk").onclick=()=>{ 
  currentRole="GK"; 
  build(); 
};

// Multiplicador
playerLevelSelect.addEventListener("change", e=>{
  currentMultiplier=parseFloat(e.target.value);
  if(lastShownChar && currentMode==="players") showStats(lastShownChar);
});

/* =========================================================
   FILTROS
========================================================= */
const filterBtn=document.getElementById("filter-btn");
const filterDropdown=document.getElementById("filter-dropdown");
const filterGender=document.getElementById("filter-gender");
const filterElement=document.getElementById("filter-element");
const resetFiltersBtn=document.getElementById("reset-filters");

filterBtn.onclick=e=>{ e.stopPropagation(); filterDropdown.style.display = filterDropdown.style.display==="flex"?"none":"flex"; };
filterDropdown.onclick=e=>e.stopPropagation();
document.addEventListener("click",()=>{ filterDropdown.style.display="none"; });

filterGender.onchange=e=>{ 
  currentFilterGender=e.target.value; 
  build(); // Sempre rebuild, independente do modo
};
filterElement.onchange=e=>{ 
  currentFilterElement=e.target.value; 
  build(); // Sempre rebuild, independente do modo
};
resetFiltersBtn.onclick=()=>{
  currentFilterGender=""; currentFilterElement="";
  filterGender.value=""; filterElement.value="";
  build(); // Sempre rebuild, independente do modo
};

/* =========================================================
   SEARCH
========================================================= */
const SECRET_IMAGE ="https://dxi4wb638ujep.cloudfront.net/1/prd/assets/4/img/shared/icn_secret_character.png";
const searchBar=document.getElementById("search-bar");
const searchResults=document.getElementById("search-results");

searchBar.addEventListener("input", ()=>{
  const q=searchBar.value.toLowerCase();
  searchResults.innerHTML="";
  if(!q) return;
  const filtered=rows.filter(r=>

  r.Image !== SECRET_IMAGE &&

  (
    r.name?.toLowerCase().includes(q) ||
    r["Name(Localised)"]?.toLowerCase().includes(q)
  )

);
  filtered.slice(0,50).forEach(r=>{
    const div=document.createElement("div");
    div.className="search-item";
    div.innerHTML=`<img src="${r.Image}"><span>${r.name} (${r["Name(Localised)"]||""})</span>`;
    div.onclick=()=>{
	  searchResults.innerHTML="";
	  searchBar.value="";
	  currentRole = r.role;

	  // Se estiver em Players
	  if(currentMode === "players"){
		document.getElementById("tab-players").classList.add("active");
		document.getElementById("tab-basara").classList.remove("active");

		updatePositionTabs();

		lastSelectedTier[r.role].players = r.tier;
		buildPlayers(r.role);
	  } 
	  // Se estiver em Fabled
	  else {
		document.getElementById("tab-basara").classList.add("active");
		document.getElementById("tab-players").classList.remove("active");

		updatePositionTabs();

		// Descobre se o personagem é Fabled+ ou Fabled-
		const roleCfg = BASARA_STATS[r.role];
		let foundTier = "Fabled+";

		for (const key in roleCfg) {
		  if (roleCfg[key].tiers.includes(r.tier)) {
			foundTier = key;
			break;
		  }
		}

		lastSelectedTier[r.role].basara = foundTier;
		buildBasara(r.role);
	  }
	};
    searchResults.appendChild(div);
  });
});

/* =========================================================
   CUSTOM CHARACTERS
========================================================= */

const CUSTOM_TIERS = {
  FW: "G3-",
  MF: "G3-",
  DF: "G4 FB",
  GK: "G3+"
};

/* =========================================================
   LOAD CSV DATABASE
========================================================= */

function parseCSV(text){
  const lines = text.trim().split("\n");
  const headers = lines[0].split(",");

  return lines.slice(1).map(line=>{
    const values = line.split(",");

    const obj = {};
    headers.forEach((h,i)=>{
      obj[h.trim()] = values[i]?.trim();
    });

    return obj;
  });
}

function getImagePath(id,url){
  const localImages=[243,1516,1727,2620,2789,5744];

  if(localImages.includes(Number(id)))
    return `images/${id}.png`;

  return url;
}

fetch("db.csv")
.then(r=>r.text())
.then(text=>{

  const data = parseCSV(text);

  rows = data.map(r=>{

  const obj = {

    id:Number(r.ID),

    role:r.Position,

    name:r.NameJP,
    "Name(Localised)":r.NameEN,

    Gender:r.Gender,
    Element:r.Element,

    Image:getImagePath(r.ID,r.Image),

    Kick:Number(r.Kick),
    Control:Number(r.Control),
    Technique:Number(r.Technique),
    Pressure:Number(r.Pressure),
    Physical:Number(r.Physical),
    Agility:Number(r.Agility),
    Intelligence:Number(r.Intelligence)
  };

  const derived=calcDerived(obj);

  obj["Shot AT"]=derived["Shot AT"];
  obj["Focus AT"]=derived["Focus AT"];
  obj["Focus DF"]=derived["Focus DF"];
  obj["Scramble AT"]=derived["Scramble AT"];
  obj["Scramble DF"]=derived["Scramble DF"];
  obj["Castle Wall DF"]=derived["Castle Wall DF"];
  obj["KP"]=derived["KP"];

  obj["Total Stats"] =
    obj.Kick +
    obj.Control +
    obj.Technique +
    obj.Pressure +
    obj.Physical +
    obj.Agility +
    obj.Intelligence;

  obj.tier=calcTier(obj);

  return obj;

});


/* =============================
   CUSTOM AVATAR
============================= */

["FW","MF","DF","GK"].forEach(role=>{

  rows.unshift({

    id:0,

    role:role,

    name:"Custom Avatar",
    "Name(Localised)":"Custom Avatar",

    Gender:"",
    Element:"",

    Image:"images/0.png",

    Kick:0,
    Control:0,
    Technique:0,
    Pressure:0,
    Physical:0,
    Agility:0,
    Intelligence:0,

    "Shot AT":0,
    "Focus AT":0,
    "Focus DF":0,
    "Scramble AT":0,
    "Scramble DF":0,
    "Castle Wall DF":0,
    "KP":0,

    "Total Stats":0,

    tier:CUSTOM_TIERS[role]

  });

});

build();

});
</script>
</body>
</html>
